<%# locals: () -%>

<% content_for :title, "Accounting Dashboard" %>

<div class="accounting-dashboard">
  <main class="accounting-container">
    <div class="dashboard-header">
      <h1>Accounting Dashboard</h1>

      <div class="period-selector">
        <%= form_with url: admin_accounting_path, method: :get, class: "period-form" do |f| %>
          <%= f.select :period,
                       options_for_select([
                                            ['Current Month', 'current_month'],
                                            ['Last Month', 'last_month'],
                                            ['Last 30 Days', 'last_30_days'],
                                            ['Current Year', 'current_year'],
                                            ['Last Year', 'last_year'],
                                            ['All Time', 'all_time'],
                                            ['Custom Range', 'custom']
                                          ], @period),
                       {},
                       class: 'period-select',
                       onchange: 'this.form.submit()' %>

          <% if @period == 'custom' %>
            <div class="custom-date-inputs">
              <%= f.date_field :start_date, value: params[:start_date] || @start_date.to_date, class: 'date-input' %>
              <%= f.date_field :end_date, value: params[:end_date] || @end_date.to_date, class: 'date-input' %>
              <%= f.submit 'Apply', class: 'btn btn-primary' %>
            </div>
          <% end %>
        <% end %>

        <%= link_to 'Export CSV',
                    export_csv_admin_accounting_path(
                      period: @period,
                      start_date: @start_date.to_date,
                      end_date: @end_date.to_date
                    ),
                    class: 'btn btn-secondary' %>
      </div>
    </div>

    <p class="date-range">
      <strong>Period:</strong>
      <%= @start_date.strftime('%B %d, %Y') %> - <%= @end_date.strftime('%B %d, %Y') %>
    </p>

    <div class="kpi-cards">
      <div class="kpi-card">
        <div class="kpi-icon">ðŸ’°</div>
        <div class="kpi-content">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value"><%= @kpis[:total_revenue].format %></div>
          <div class="kpi-change <%= @kpis[:growth_rate] >= 0 ? 'positive' : 'negative' %>">
            <%= @kpis[:growth_rate] >= 0 ? 'â†‘' : 'â†“' %>
            <%= number_to_percentage(@kpis[:growth_rate].abs, precision: 2) %>
          </div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">ðŸ§¾</div>
        <div class="kpi-content">
          <div class="kpi-label">Transactions</div>
          <div class="kpi-value"><%= number_with_delimiter(@kpis[:transaction_count]) %></div>
          <div class="kpi-meta">Verified sales</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">ðŸ“Š</div>
        <div class="kpi-content">
          <div class="kpi-label">Avg Transaction</div>
          <div class="kpi-value"><%= @kpis[:avg_transaction_value].format %></div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">ðŸ“†</div>
        <div class="kpi-content">
          <div class="kpi-label">Subscription Time Sold</div>
          <div class="kpi-value">
            <%= number_with_delimiter(@kpis[:total_months_sold]) %> months
          </div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">ðŸ“Š</div>
        <div class="kpi-content">
          <div class="kpi-label">Avg Month Value</div>
          <div class="kpi-value"><%= @kpis[:avg_price_per_month].format %></div>
        </div>
      </div>
    </div>

    <section class="dashboard-section full-width">
      <h2>Revenue Over Time</h2>
      <div class="chart-container">
        <%= column_chart @revenue_data, suffix: ' â‚¬', height: '350px' %>
      </div>
    </section>

    <div class="two-column-layout">
      <section class="dashboard-section">
        <h2>Payment Methods</h2>

        <% if @payment_methods_data.any? %>
          <div class="chart-container">
            <%= pie_chart(@payment_methods_data.map { |pm| [pm[:name], pm[:amount_chart]] }, donut: true, suffix: ' â‚¬', height: '300px') %>
          </div>

          <table class="data-table">
            <thead>
            <tr>
              <th>Payment Method</th>
              <th>Count</th>
              <th>Amount</th>
              <th>Avg</th>
            </tr>
            </thead>
            <tbody>
            <% @payment_methods_data.each do |pm| %>
              <tr>
                <td>
                  <%= pm[:name] %>
                  <% if pm[:auto_verified] %>
                    <span class="badge">Auto</span>
                  <% end %>
                </td>
                <td><%= number_with_delimiter(pm[:count]) %></td>
                <td><%= pm[:amount].format %></td>
                <td><%= pm[:avg_value].format %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="no-data">No payment data for this period.</p>
        <% end %>
      </section>

      <section class="dashboard-section">
        <h2>Top Items</h2>

        <% if @top_items_data.any? %>
          <div class="chart-container">
            <%= column_chart(@top_items_data.first(10).map { |i| [i[:name], i[:revenue].to_f] }, suffix: ' â‚¬', height: '300px') %>
          </div>

          <table class="data-table">
            <thead>
            <tr>
              <th>Item</th>
              <th>Type</th>
              <th>Qty</th>
              <th>Revenue</th>
              <th>% of Total</th>
            </tr>
            </thead>
            <tbody>
            <% @top_items_data.each do |item| %>
              <tr>
                <td><%= item[:name] %></td>
                <td><span class="badge <%= item[:type].downcase %>"><%= item[:type] %></span></td>
                <td><%= number_with_delimiter(item[:quantity]) %></td>
                <td><%= item[:revenue].format %></td>
                <td><%= number_to_percentage(item[:percentage], precision: 1) %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="no-data">No items sold in this period.</p>
        <% end %>
      </section>
    </div>

    <section class="dashboard-section full-width">
      <h2>Recent Sales</h2>

      <% if @recent_sales.any? %>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
            <tr>
              <th>Sale ID</th>
              <th>Date</th>
              <th>Client</th>
              <th>Seller</th>
              <th>Payment Method</th>
              <th>Items</th>
              <th>Total</th>
              <th>Invoice</th>
            </tr>
            </thead>
            <tbody>
            <% @recent_sales.each do |sale| %>
              <tr>
                <td>#<%= sale[:id] %></td>
                <td><%= sale[:date].strftime('%Y-%m-%d %H:%M') %></td>
                <td><%= sale[:client] %></td>
                <td><%= sale[:seller] %></td>
                <td><%= sale[:payment_method] %></td>
                <td><%= number_with_delimiter(sale[:items_count]) %></td>
                <td><%= sale[:total].format %></td>
                <td>
                  <span class="badge coming-soon" title="Coming soon">ðŸ“„ PDF</span>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="no-data">No sales in this period.</p>
      <% end %>
    </section>

    <div class="two-column-layout">
      <section class="dashboard-section">
        <h2>Customer Metrics</h2>

        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-label">New Customers</div>
            <div class="metric-value">
              <%= number_with_delimiter(@customer_metrics[:new_customers]) %>
            </div>
          </div>

          <div class="metric-item">
            <div class="metric-label">Total Customers</div>
            <div class="metric-value">
              <%= number_with_delimiter(@customer_metrics[:total_customers]) %>
            </div>
          </div>

          <div class="metric-item">
            <div class="metric-label">Avg Customer LTV</div>
            <div class="metric-value">
              <%= @customer_metrics[:avg_lifetime_value].format %>
            </div>
          </div>
        </div>

        <% if @customer_metrics[:top_customers].any? %>
          <h3>Top Customers</h3>
          <table class="data-table compact">
            <thead>
            <tr>
              <th>Customer</th>
              <th>Revenue</th>
              <th>Orders</th>
            </tr>
            </thead>
            <tbody>
            <% @customer_metrics[:top_customers].first(5).each do |customer| %>
              <tr>
                <td><%= customer[:name] %></td>
                <td><%= customer[:revenue].format %></td>
                <td><%= number_with_delimiter(customer[:transaction_count]) %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        <% end %>
      </section>

      <section class="dashboard-section">
        <h2>Sales by Seller</h2>

        <% if @sales_by_seller.any? %>
          <table class="data-table">
            <thead>
            <tr>
              <th>Seller</th>
              <th>Sales Count</th>
              <th>Revenue</th>
            </tr>
            </thead>
            <tbody>
            <% @sales_by_seller.first(8).each do |seller| %>
              <tr>
                <td><%= seller[:name] %></td>
                <td><%= number_with_delimiter(seller[:count]) %></td>
                <td><%= seller[:revenue].format %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="no-data">No seller data available for this period.</p>
        <% end %>
      </section>
    </div>
  </main>
</div>
